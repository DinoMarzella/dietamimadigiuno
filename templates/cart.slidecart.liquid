{% layout none %}
{% if cart.items.size > 0 %}
{%- assign cartItems = cart.items -%}
{% endif %}
[
{% for item in cartItems %}

{% assign handle = item.url | split: '?' | first |replace :'/products/':'' %}

{% for prop in item.properties%}

{% if prop.first == "_product" and prop.last !="" %}
{% assign handle= prop.last %}
{% endif%}
{% endfor %}

{% assign currentProduct = all_products[handle] %}
{%- assign mediaImages = nil -%}
{% if currentProduct.metafields.custom.recommended_upsells.value %}
{%- capture mediaImages -%}{
{%- for upsell in currentProduct.metafields.custom.recommended_upsells.value -%}
{%- assign featured_image = upsell.product.featured_image | img_url: '400x' -%}
"{{upsell.id}}": "{{featured_image}}"
{%- unless forloop.last -%},{%- endunless -%}



{%- endfor -%}
}
{%- endcapture -%}
{% endif%}
{%- capture bundle_components -%}
{% if item.item_components %}
"bundle_components":[
{%- for cartItem in item.item_components -%}
{
"product_title": {{cartItem..product.title | json }},
"product_id": {{cartItem.product.id | json }},
"variant_id": {{cartItem.variant.id | json }},
"quantity": {{cartItem.quantity | json }},
"variant_title": {{cartItem.variant.title | json }},
"featured_image": {{cartItem.product.featured_image | img_url: '400x' | json }}
}
{%- unless forloop.last %},{% endunless -%}
{%- endfor -%}

],


{%- endif -%}


{% endcapture %}


{
"handle": {{handle | json }},
"variant_id": {{item.variant_id | json}},
"product_id": {{item.product_id | json}},
"qty":{{item.quantity | json}},
"line_price":{{item.final_line_price |json}},
"collections":{{currentProduct.collections | json}},
"tags":{{currentProduct.collections |json }},
"custom_metafields": {{item.variant.metafields.custom | json}},
"bundle_items":{{item.variant.metafields.custom.prolon_bundle_items.value | json}},
{{bundle_components}}
"upsell_products":{{currentProduct.metafields.custom.recommended_upsells.value |json }}
{% if mediaImages %},
"mediaImages":{{mediaImages }}
{% endif %}
}
{% unless forloop.last %},{% endunless %}




{% endfor %}
] 